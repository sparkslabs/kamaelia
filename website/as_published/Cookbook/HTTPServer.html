<html>
<head>
<title> Cookbook/HTTPServer </title>
<meta name="description" content="Kamaelia - making concurrency simpler in python - Cookbook/HTTPServer">
<meta name="keywords" content="python concurrency generators threads processes component system experts beginners media networking">
<link rel=stylesheet type="text/css" href="/newcss.css">
  </head>
<body style="font-size: 10pt; font-family: verdana,arial,helvetica,sans-serif; line-height: 1.8;">
</div>

</span></p>

<div id="centreinbrowser">
    <table><tr><td>
        <div id="contentwrapper">
            <div id="contentpanel">
                <div class="column twoC largertext">  &nbsp; </div>
                <div class="column twoC largertext">  &nbsp;  </div>
                <div class="column twoC largertext"> <P class="orange" align="center">  <b><a href="/Home.html"> Home</a></b> </div>
                <div class="column twoC largertext"> 
<P class="orange" align="center"> 
<b><a href="/About.html" class="smallertext">About</a>, 
<a href="/Sitemap.html" class="smallertext">Index</a>, 
<a href="/RecentChanges.html" class="smallertext">Changes</a></b>
  </div>
                <div class="column twoC largertext"> <P class="orange" align="center">  <b> <a href="/Developers/">Developers</a> </b> </div>
                <div class="column last twoC"> <P class="orange" align="center"> 
<b>
<span class="largertext">&nbsp;</span>
<!--   <span class="largertext"><a href="/UserLogin.html">Login</a>/<a href="/UserRegistration.html">Register</a> </span>  -->
<!--  </b> -->
</b>
 </div>

<div class="divide"></div>
                <div id="masthead">
                    &nbsp;
                    <br>
                </div>
                <div class="fourC column">
                    &nbsp;
                </div>
                <div class="fourC column">
                    &nbsp;
                </div>
                <div class="fourC column last">
                    &nbsp;
                </div>
<div class="divide"></div>
                <div class="twoC column">
                    &nbsp;
                </div>
                <div class="eightC column">
                


<h1>Cookbook: HTTPServer</h1>
<p><div style="float: right; border: solid;" class="twoC"> The API for HTTPServer is likely to change/improve for the better - stay tuned!</div> The HTTP Server included in Kamaelia 0.5 / Megabundle 1.4 is a useful &amp; powerful mechanism, but lacks an example. Hence this page!</p><p>Some initial points:</p><ul><li>Kamaelia.Protocol.HTTP.HTTPServer.HTTPServer actually implements a protocol handler rather than the server aspects. As a result it's perhaps badly named, but is designed to be used as a protocol handler for the SimpleServer component.<br>
</li><li>By itself, it can handle all sorts of aspects of the HTTP protocol, but doesn't actually know how to handle any of these sorts of requests.</li><li>As a result, you create a function to handle the actual incoming requests.</li><li>The code in Kamaelia.Protocol.HTTP.HTTPResourceGlue is infact an example, rather than really being something you can directly import and use.</li><li>The existing handlers have no knowledge of configuration, which mean when you create them that's when you need to configure them. In the case of a webserver this changes how you create them.,<br></li></ul><h2>A beginning example</h2>So, this therefore means in order to use the HTTP Server as is:<br><ul><li>You need to create wrapper functions around the handlers you wish to use, so that you can configure them</li><li>You need to tell the HTTPServer component when to use these handler - you do this by creating a factory function.</li><li>You need to tell the SimpleServer component to use your configured HTTPServer factory to handle new connections (new requests)</li></ul>Also, there's one final thing: it's nice, for various reasons, to change the socket options for the server, so we do that in how we configure SimpleServer.<br>Code:<br><blockquote><pre><i>#!/usr/bin/python</i></pre><i># Import socket to get at constants for socketOptions</i><br><pre><b>import</b> socket</pre><i># Import the server framework, the HTTP protocol handling, the minimal request handler, and error handlers</i><br><pre><b>from</b> Kamaelia.Chassis.ConnectedServer <b>import</b> SimpleServer<br><b>from</b> Kamaelia.Protocol.HTTP.HTTPServer <b>import</b> HTTPServer<br><b>from</b> Kamaelia.Protocol.HTTP.Handlers.Minimal <b>import</b> Minimal<br><b>import</b> Kamaelia.Protocol.HTTP.ErrorPages <b>as</b> ErrorPages</pre><i># Our configuration</i><br><pre>homedirectory = "/srv/www/htdocs"<br>indexfilename = "index.html"</pre><i># This allows for configuring the request handlers in a nicer way. This is  candidate<br># for merging into the mainline code. Effectively this is a factory that creates functions<br># capable of choosing which request handler to use.</i><br><pre>def requestHandlers(URLHandlers):<br>    def createRequestHandler(request):<br>        if request.get("bad"):<br>            return ErrorPages.websiteErrorPage(400, request.get("errormsg",""))<br>        else:<br>            for (prefix, handler) in URLHandlers:<br>                if request["raw-uri"][:len(prefix)] == prefix:<br>                    request["uri-prefix-trigger"] = prefix<br>                    request["uri-suffix"] = request["raw-uri"][len(prefix):]<br>                    return handler(request)<br><br>        return ErrorPages.websiteErrorPage(404, "No resource handlers could be found for the requested URL")<br><br>    return createRequestHandler</pre><i># This factory allows us to configure the minimal request handler.</i> <br><pre>def servePage(request):<br>    return Minimal(request=request,<br>                   homedirectory=homedirectory,<br>                   indexfilename=indexfilename)</pre><br><i># A factory to create configured HTTPServer components - ie HTTP Protocol handling components</i><br><pre>def HTTPProtocol():<br>    return HTTPServer(requestHandlers([<br>                          ["/", servePage ],<br>                      ]))</pre><i># Finally we create the actual server and run it.</i><br><pre>SimpleServer(protocol=HTTPProtocol,<br>             port=8082,<br>             socketOptions=(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)  ).run()</pre></blockquote><h2>Writing your own first response handler<br></h2>
OK, so that's all well and good, and shows how to run the Kamaelia webserver as, well, a webserver, but how do we integrate with other components? Well this requires you to start think about requests and responses - specifically you need to learn how to write a request handler!<br><br>Fortunately this is relatively simple - you do this:<br><ul><li>Your handler is created by a function call with the request in - ie YourHandler(request)</li><li>This is expected to return a component.</li><li>Your component then runs and any responses sent to your outbox are either sent to the user or used to control what is sent to the user.</li></ul>Specifically there's three key kinds of messages you'll probably send:<br><ul><li>An initial message to denote the page type you're seding (eg text/html)</li><li>Data messages. (ie page data) You MUST yield after every message you send at present or you risk your data not being served.</li><li>A shutdown message when your handler has completed producing data!<br></li></ul>So, given all that, this is what a handler actually looks like:<br><blockquote><pre><b>class</b> HelloHandler(Axon.Component.component):<br>    <b>def</b> __init__(self, request):<br>        super(HelloHandler, self).__init__()<br>        self.request = request<br><br>    <b>def</b> main(self):<br>        resource = {<br>           "type"           : "text/html",<br>           "statuscode"     : "200",<br>        }<br>        self.send(resource, "outbox"); <b>yield</b> 1<br>        page = {<br>          "data" : "&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello World&lt;/h1&gt;&lt;P&gt;Woo!!&lt;/body&gt;&lt;/html&gt;",<br>        }<br>        self.send(page, "outbox"); <b>yield</b> 1<br>        self.send(Axon.Ipc.producerFinished(self), "signal")<br>        <b>yield</b> 1</pre></blockquote>So, that's your handler. To integrate this into our example from above:<br><br><blockquote><pre><i>#!/usr/bin/python</i></pre><i># Import socket to get at constants for socketOptions</i><br><pre><b>import</b> socket</pre><pre><i><font><font color="#006600"># We need to import Axon - Kamaelia's core component system - to write Kamaelia components!<br></font></font></i><b><font><b><font color="#006600">import Axon</font></b></font></b></pre><i># Import the server framework, the HTTP protocol handling, the minimal request handler, and error handlers</i><br><pre><b>from</b> Kamaelia.Chassis.ConnectedServer <b>import</b> SimpleServer<br><b>from</b> Kamaelia.Protocol.HTTP.HTTPServer <b>import</b> HTTPServer<br><b>from</b> Kamaelia.Protocol.HTTP.Handlers.Minimal <b>import</b> Minimal<br><b>import</b> Kamaelia.Protocol.HTTP.ErrorPages <b>as</b> ErrorPages</pre><i># Our configuration</i><br><pre>homedirectory = "/srv/www/htdocs"<br>indexfilename = "index.html"</pre><i># This allows for configuring the request handlers in a nicer way. This is  candidate<br># for merging into the mainline code. Effectively this is a factory that creates functions<br># capable of choosing which request handler to use.</i><br><pre>def requestHandlers(URLHandlers):<br>    def createRequestHandler(request):<br>        if request.get("bad"):<br>            return ErrorPages.websiteErrorPage(400, request.get("errormsg",""))<br>        else:<br>            for (prefix, handler) in URLHandlers:<br>                if request["raw-uri"][:len(prefix)] == prefix:<br>                    request["uri-prefix-trigger"] = prefix<br>                    request["uri-suffix"] = request["raw-uri"][len(prefix):]<br>                    return handler(request)<br><br>        return ErrorPages.websiteErrorPage(404, "No resource handlers could be found for the requested URL")<br><br>    return createRequestHandler</pre><i></i><pre><b><font color="#006600">class HelloHandler(Axon.Component.component):<br>    def __init__(self, request):<br>        super(HelloHandler, self).__init__()<br>        self.request = request<br><br>    def main(self):<br>        resource = {<br>           "type"           : "text/html",<br>           "statuscode"     : "200",<br>        }<br>        self.send(resource, "outbox"); yield 1<br>        page = {<br>          "data" : "&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello World&lt;/h1&gt;&lt;P&gt;Woo!!&lt;/body&gt;&lt;/html&gt;",<br>        }<br>        self.send(page, "outbox"); yield 1<br>        self.send(Axon.Ipc.producerFinished(self), "signal")<br>        yield 1</font></b><p><br>def servePage(request):<br>    return Minimal(request=request,<br>                   homedirectory=homedirectory,<br>                   indexfilename=indexfilename)</p></pre><br><i># A factory to create configured HTTPServer components - ie HTTP Protocol handling components</i><br><pre>def HTTPProtocol():<br>    return HTTPServer(requestHandlers([<br><b><font color="#009900">                          ["/hello", HelloHandler ],<br></font></b>                          ["/", servePage ],<br>                      ]))</pre><i># Finally we create the actual server and run it.</i><br><pre>SimpleServer(protocol=HTTPProtocol,<br>             port=8082,<br>             socketOptions=(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)  ).run()</pre></blockquote>As you can see we added in the code as expected, and added in the handler into the method at the end.<br><ul><li><b>Note:</b> the order of handlers <b>does</b> matter (which is why a list is used) - the first hander who's prefix matches is the handler used to handle the request.<br></li></ul><h2>Writing a response handler to use a Pipeline</h2>
This turns out to be quite simple if you have 2 components which can be reused.<br><ul><li>One takes an argument (eg a request dictionary) and sends it out its outbox "outbox" (this enables it to start off a Pipeline)</li><li>One that takes the first value it sees, and stuffs it into an HTML response and sends that out its outbox.</li></ul>These are both quite simple to write. <br><br><b>One takes an argument (eg a request dictionary) and sends it out its outbox "outbox" (this enables it to start off a Pipeline)</b><br><blockquote><pre>class Cat(Axon.Component.component):<br>    def __init__(self, *args):<br>        super(Cat, self).__init__()<br>        self.args = args<br>    def main(self):<br>        self.send(self.args, "outbox")<br>        self.send(Axon.Ipc.producerFinished(self), "signal")<br>        yield 1</pre></blockquote><b>One that takes the first value it sees, and stuffs it into an HTML response and sends that out its outbox.</b><br><blockquote><pre>class ExampleWrapper(Axon.Component.component):<br>    def main(self):<br>        <i># Tell the browser the type of data we're sending!<br></i>        resource = {<br>           "type"           : "text/html",<br>           "statuscode"     : "200",<br>        }<br>        self.send(resource, "outbox"); yield 1<br><i>        # Send the header<br></i>        header = {<br>          "data" : "&lt;html&gt;&lt;body&gt;"<br>        }<br>        self.send(header, "outbox"); yield 1<br><i>        # Wait for it....</i><br>        while not self.dataReady("inbox"):<br>            self.pause()<br>            yield 1<br><br><i>        # Send the data we recieve as the page body<br></i>        while self.dataReady("inbox"):<br>            pageData = {<br>               "data" : str(self.recv("inbox"))<br>            }<br>            self.send(pageData, "outbox"); yield 1<br><br><i>        # send a footer<br></i>        footer = {<br>          "data" : "&lt;/body&gt;&lt;/html&gt;"<br>        }<br>        self.send(footer, "outbox"); yield 1<br><br><i>        # and shutdown nicely<br></i>        self.send(Axon.Ipc.producerFinished(self), "signal")<br>        yield 1</pre></blockquote>Given these two components, which can be reused to your hearts content, we can produce a simple "Echo" handler as follows:<br><blockquote><pre>from Kamaelia.Chassis.Pipeline import Pipeline<br><br>def EchoHandler(request):<br>    return Pipeline ( Cat(request), ExampleWrapper() )</pre></blockquote>Which is actually quite sweet :-)<br><br>Putting this into our example, and how it modifies our server....<br><br><blockquote><pre><i>#!/usr/bin/python</i></pre><i># Import socket to get at constants for socketOptions</i><br><pre><b>import</b> socket</pre><pre><i><font><font color="#006600"># We need to import Axon - Kamaelia's core component system - to write Kamaelia components!<br></font></font></i><b><font><b><font color="#006600">import Axon</font></b></font></b></pre>
<i># Import the server framework, the HTTP protocol handling, the minimal request handler, and error handlers</i><br><pre><b>from</b> Kamaelia.Chassis.ConnectedServer <b>import</b> SimpleServer<br><b>from</b> Kamaelia.Protocol.HTTP.HTTPServer <b>import</b> HTTPServer<br><b>from</b> Kamaelia.Protocol.HTTP.Handlers.Minimal <b>import</b> Minimal<br><b>import</b> Kamaelia.Protocol.HTTP.ErrorPages <b>as</b> ErrorPages</pre><pre><font color="#009900"><b>from Kamaelia.Chassis.Pipeline import Pipeline</b></font><br></pre><i># Our configuration</i><br><pre>homedirectory = "/srv/www/htdocs"<br>indexfilename = "index.html"</pre><i># This allows for configuring the request handlers in a nicer way. This is  candidate<br># for merging into the mainline code. Effectively this is a factory that creates functions<br># capable of choosing which request handler to use.</i><br><pre>def requestHandlers(URLHandlers):<br>    def createRequestHandler(request):<br>        if request.get("bad"):<br>            return ErrorPages.websiteErrorPage(400, request.get("errormsg",""))<br>        else:<br>            for (prefix, handler) in URLHandlers:<br>                if request["raw-uri"][:len(prefix)] == prefix:<br>                    request["uri-prefix-trigger"] = prefix<br>                    request["uri-suffix"] = request["raw-uri"][len(prefix):]<br>                    return handler(request)<br><br>        return ErrorPages.websiteErrorPage(404, "No resource handlers could be found for the requested URL")<br><br>    return createRequestHandler</pre><pre><font color="#000000">class HelloHandler(Axon.Component.component):<br>    def __init__(self, request):<br>        super(HelloHandler, self).__init__()<br>        self.request = request<br><br>    def main(self):<br>        resource = {<br>           "type"           : "text/html",<br>           "statuscode"     : "200",<br>        }<br>        self.send(resource, "outbox"); yield 1<br>        page = {<br>          "data" : "&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello World&lt;/h1&gt;&lt;P&gt;Woo!!&lt;/body&gt;&lt;/html&gt;",<br>        }<br>        self.send(page, "outbox"); yield 1<br>        self.send(Axon.Ipc.producerFinished(self), "signal")<br>        yield 1</font><p><br>def servePage(request):<br>    return Minimal(request=request,<br>                   homedirectory=homedirectory,<br>                   indexfilename=indexfilename)</p></pre><br><pre><font color="#009900"><b>class Cat(Axon.Component.component):<br>    def __init__(self, *args):<br>        super(Cat, self).__init__()<br>        self.args = args<br>    def main(self):<br>        self.send(self.args, "outbox")<br>        self.send(Axon.Ipc.producerFinished(self), "signal")<br>        yield 1<br><br>class ExampleWrapper(Axon.Component.component):<br>    def main(self):<br>        <i># Tell the browser the type of data we're sending!<br></i>        resource = {<br>           "type"           : "text/html",<br>           "statuscode"     : "200",<br>        }<br>        self.send(resource, "outbox"); yield 1<br><i>        # Send the header<br></i>        header = {<br>          "data" : "&lt;html&gt;&lt;body&gt;"<br>        }<br>        self.send(header, "outbox"); yield 1<br><i>        # Wait for it....</i><br>        while not self.dataReady("inbox"):<br>            self.pause()<br>            yield 1<br><br><i>        # Send the data we recieve as the page body<br></i>        while self.dataReady("inbox"):<br>            pageData = {<br>               "data" : str(self.recv("inbox"))<br>            }<br>            self.send(pageData, "outbox"); yield 1<br><br><i>        # send a footer<br></i>        footer = {<br>          "data" : "&lt;/body&gt;&lt;/html&gt;"<br>        }<br>        self.send(footer, "outbox"); yield 1<br><br><i>        # and shutdown nicely<br></i>        self.send(Axon.Ipc.producerFinished(self), "signal")<br>        yield 1<br><br>def EchoHandler(request):<br>    return Pipeline ( Cat(request), ExampleWrapper() )<br></b></font></pre><i># A factory to create configured HTTPServer components - ie HTTP Protocol handling components</i><br><pre>def HTTPProtocol():<br>    return HTTPServer(requestHandlers([<br><b><font><b><font color="#009900">                          ["/echo",  EchoHandler ],</font></b></font></b><br><b><font><b><font color="#009900">                          </font></b></font></b><font color="#000000">["/hello", HelloHandler ],</font><b><font><b><font color="#009900"><br></font></b></font></b><font color="#009900"><b>                          </b></font>["/", servePage ],<br>                      ]))</pre><i># Finally we create the actual server and run it.</i><br><pre>SimpleServer(protocol=HTTPProtocol,<br>             port=8082,<br>             socketOptions=(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)  ).run()</pre></blockquote><h2>Final Comments</h2>Some of the API on this is likely to be revamped slightly based on writing this cookbook page. Specifically a number of functions and components on this page are likely to migrate into the codebase! (making your life easier)<br><br><br><br>
                </div>
                <div class="twoC column last">
                    &nbsp;
                </div>
                <div id="footer">
                    &nbsp;
                    <br>&nbsp;
                </div>


<div class="divide"></div>
            </div>
        </div>
    </td></tr></table>


<hr>
<div id="aboutblock" style="text-align: left"; padding-left: 1em;>
<font size="-2">
   <P><img src="http://www.kamaelia.org/images/BBC-ResearchLogo-Small.png"
style="float: left; padding-right: 10px; margin-bottom: 3em;"> <a href="http://www.kamaelia.org/Home.html">Kamaelia</a>
    is an open source project originated from and guided by <a href="http://www.bbc.co.uk/rd"> BBC 
    Research</a>. For more information browse the site or get in 
    <a href="/Contact.html">contact</a>.
   <P>This is an ongoing community based development site. As a result the
   contents of this page is the opinions of the contributors of the pages
   involved not the organisations involved. Specificially, this page may
   contain personal views which are not the views of the BBC. (the site is
   powered by a wiki engine)
   <P>(C) Copyright 2008 Kamaelia Contributors, including the British
   Broadcasting Corporation, All Rights Reserved
</font>
</div>
</div>
<div style="display:none">
This web site is powered by the same code created for the
<a href="http://www.bickermanor.org/"> bicker manor</a> project. For more
details, contact Michael Sparks at BBC Research directly (cf contact)
</div>
</body>
</html>



